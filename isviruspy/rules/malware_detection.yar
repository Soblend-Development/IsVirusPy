/*
    Reglas YARA para detección de malware
    IsVirusPY - Reglas de ejemplo basadas en mejores prácticas 2025
*/

import "math"

rule Suspicious_High_Entropy
{
    meta:
        description = "Detecta archivos con alta entropía - posible empaquetamiento o cifrado"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "medium"
    
    condition:
        uint16(0) == 0x5A4D and
        filesize < 5MB and
        math.entropy(0, filesize) > 7.0
}

rule Suspicious_Packer_UPX
{
    meta:
        description = "Detecta empaquetador UPX"
        author = "IsVirusPY"
        date = "2025-11-09"
        packer = "UPX"
    
    strings:
        $upx1 = "UPX0"
        $upx2 = "UPX1"
        $upx3 = "UPX!"
    
    condition:
        uint16(0) == 0x5A4D and
        any of ($upx*)
}

rule Code_Injection_APIs
{
    meta:
        description = "Detecta APIs comunes de inyección de código"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "high"
        technique = "T1055"
    
    strings:
        $api1 = "VirtualAllocEx" ascii wide
        $api2 = "WriteProcessMemory" ascii wide
        $api3 = "CreateRemoteThread" ascii wide
        $api4 = "NtCreateThreadEx" ascii wide
        $api5 = "QueueUserAPC" ascii wide
        $api6 = "SetThreadContext" ascii wide
    
    condition:
        uint16(0) == 0x5A4D and
        3 of ($api*)
}

rule Ransomware_Behavior
{
    meta:
        description = "Detecta comportamiento típico de ransomware"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "critical"
        malware_type = "Ransomware"
    
    strings:
        $crypt1 = "CryptEncrypt" ascii wide
        $crypt2 = "CryptAcquireContext" ascii wide
        $crypt3 = "CryptGenKey" ascii wide
        $file1 = "FindFirstFile" ascii wide
        $file2 = "FindNextFile" ascii wide
        $ext1 = ".encrypted" ascii wide
        $ext2 = ".locked" ascii wide
        $ext3 = ".crypt" ascii wide
        $ransom = "Your files have been encrypted" ascii wide nocase
        $bitcoin = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}/ ascii
    
    condition:
        uint16(0) == 0x5A4D and
        (
            (2 of ($crypt*) and 2 of ($file*)) or
            (any of ($ext*) and $ransom) or
            ($bitcoin and any of ($crypt*))
        )
}

rule Keylogger_Behavior
{
    meta:
        description = "Detecta comportamiento de keylogger"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "high"
        technique = "T1056.001"
    
    strings:
        $api1 = "GetAsyncKeyState" ascii wide
        $api2 = "GetKeyState" ascii wide
        $api3 = "SetWindowsHookEx" ascii wide
        $api4 = "GetForegroundWindow" ascii wide
        $api5 = "GetWindowText" ascii wide
    
    condition:
        uint16(0) == 0x5A4D and
        3 of them
}

rule Persistence_Registry
{
    meta:
        description = "Detecta modificación de registro para persistencia"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "medium"
        technique = "T1547.001"
    
    strings:
        $reg1 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide nocase
        $reg2 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce" ascii wide nocase
        $reg3 = "RegSetValueEx" ascii wide
        $reg4 = "RegCreateKey" ascii wide
    
    condition:
        uint16(0) == 0x5A4D and
        (any of ($reg1, $reg2) and any of ($reg3, $reg4))
}

rule AntiDebug_Techniques
{
    meta:
        description = "Detecta técnicas anti-debugging"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "medium"
    
    strings:
        $api1 = "IsDebuggerPresent" ascii wide
        $api2 = "CheckRemoteDebuggerPresent" ascii wide
        $api3 = "NtQueryInformationProcess" ascii wide
        $api4 = "OutputDebugString" ascii wide
        $vm1 = "VMware" ascii wide nocase
        $vm2 = "VirtualBox" ascii wide nocase
        $vm3 = "VBOX" ascii wide nocase
    
    condition:
        uint16(0) == 0x5A4D and
        (2 of ($api*) or any of ($vm*))
}

rule Downloader_Suspicious
{
    meta:
        description = "Detecta capacidad de descarga de archivos"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "medium"
    
    strings:
        $url1 = "URLDownloadToFile" ascii wide
        $url2 = "InternetOpenUrl" ascii wide
        $url3 = "InternetReadFile" ascii wide
        $url4 = "HttpSendRequest" ascii wide
        $http = /https?:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}/ ascii
    
    condition:
        uint16(0) == 0x5A4D and
        2 of ($url*) and $http
}

rule Powershell_Embedded
{
    meta:
        description = "Detecta PowerShell embebido (común en malware)"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "medium"
    
    strings:
        $ps1 = "powershell" ascii wide nocase
        $ps2 = "Invoke-Expression" ascii wide nocase
        $ps3 = "IEX" ascii wide
        $ps4 = "-EncodedCommand" ascii wide nocase
        $ps5 = "-ExecutionPolicy Bypass" ascii wide nocase
        $ps6 = "System.Management.Automation" ascii wide
    
    condition:
        uint16(0) == 0x5A4D and
        $ps1 and 2 of ($ps2, $ps3, $ps4, $ps5, $ps6)
}

rule Suspicious_Strings_Generic
{
    meta:
        description = "Detecta strings sospechosas genéricas"
        author = "IsVirusPY"
        date = "2025-11-09"
        severity = "low"
    
    strings:
        $str1 = "trojan" ascii wide nocase
        $str2 = "backdoor" ascii wide nocase
        $str3 = "payload" ascii wide nocase
        $str4 = "shell" ascii wide nocase
        $str5 = "cmd.exe" ascii wide nocase
        $str6 = "net user" ascii wide nocase
        $str7 = "password" ascii wide nocase
        $cmd = /cmd\.exe\s+\/c/ ascii wide
    
    condition:
        uint16(0) == 0x5A4D and
        4 of them
}
